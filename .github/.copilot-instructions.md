# LookBook Project - Copilot Instructions

## Project Overview
LookBook is a React TypeScript web application for managing and documenting personal fashion looks. Users can create "looks" with photos from Google Photos, scan product barcodes to add beauty/fashion items, and organize their fashion choices by date. The app integrates with Google Photos API for image management and includes barcode scanning for product identification.

## Architecture & Tech Stack

### Core Technologies
- **Frontend**: React 18 with TypeScript
- **Build System**: Create React App (CRA) with react-scripts 5.0.1
- **Routing**: React Router DOM v6
- **Styling**: CSS modules and component-specific stylesheets
- **Backend**: AWS Lambda (Node.js) for product lookup services
- **Deployment**: Static hosting on AWS S3 with CloudFront
- **Infrastructure**: Terraform for AWS resource management

### Key Libraries & Dependencies
- `@ericblade/quagga2`: Barcode scanning functionality
- `react-edit-text`: Inline text editing components
- `react-router-dom`: Client-side routing
- **Google APIs**: Photos Library API for album/photo integration
- **AWS Services**: Lambda, S3, Route 53, API Gateway

## Project Structure & Key Components

### Core Application Flow
1. **App.tsx**: Main router component that determines which Look to display based on date
2. **Look Component**: Central component for creating/editing fashion looks
3. **Google Photos Integration**: Authentication and photo selection from Google Photos albums
4. **Product Management**: Barcode scanning and product lookup via UPC database
5. **Local Storage Persistence**: All data stored locally in browser localStorage

### Component Architecture

#### Primary Components
- **`Look`** (`src/components/looks/look.tsx`): Main component for managing individual looks
  - Implements `LookModel` interface
  - Handles CRUD operations via localStorage
  - Integrates photos, tags, and products
  - Uses auto-generated UUID for identification
  - Date-based naming system ("Today's Look")

- **`LookOccurrence`** (`src/components/looks/lookOccurrence.tsx`): Manages date-specific instances of looks
  - Tracks photos added to specific look instances
  - Handles photo storage via localStorage keys like `${lookId}.${date}.photos`

- **`GooglePhotosAuthButton`** (`src/components/photos/authorize.mjs`): OAuth2 integration
  - Handles Google Photos API authentication
  - Manages API client initialization and token handling
  - Uses singleton pattern via `GoogleAuthService`

- **`AlbumPicker`** (`src/components/photos/albumpicker.tsx`): Google Photos album selection
  - Lists available Google Photos albums
  - Enables photo selection from albums

- **`ProductScanner`** (`src/components/products/productScanner.tsx`): Barcode scanning interface
  - Wraps QuaggaImpl barcode scanner
  - Integrates with product lookup service

#### Utility Components
- **`Persisted`** (`src/components/util/persisted.tsx`): Abstract base class for localStorage persistence
  - Provides standardized CRUD operations
  - Automatic collection management
  - Lazy loading of persisted objects
  - Used by various components for data persistence

- **`OnScreenConsole`** (`src/components/util/onScreenConsole.tsx`): Debug utility
  - Displays console logs on-screen for mobile debugging

### Data Models & Interfaces

#### Core Models
```typescript
// LookModel: Primary data structure
interface LookModel {
    id?: string;
    name?: string; 
    created?: Date;
}

// ProductModel: Product information
interface ProductModel {
    id?: string;
    name?: string;
    type?: ProductType; // enum: Skincare, Makeup, Hair, etc.
    barcode?: string;
}

// PersistedModel: Base interface for localStorage objects
interface PersistedModel {
    id?: string;
}
```

### External Integrations

#### Google Photos API
- **Authentication**: OAuth2 via Google Identity Services
- **Scopes**: Full read/write access to user's Google Photos
- **Services**: 
  - `GoogleAuthService`: Static authentication state management
  - `GooglePhotosService`: Album and photo operations
- **Storage**: API keys and client IDs stored in component constants

#### Product Lookup Service
- **AWS Lambda**: Proxies requests to UPCItemDB.com
- **Endpoint**: `https://api.upcitemdb.com/prod/trial/lookup`
- **Function**: Takes barcode, returns product name, images, and purchase links
- **Fallback**: Returns "unrecognized" for unknown barcodes

#### Barcode Scanning (Quagga2)
- **Camera Integration**: Requests camera permissions
- **Supported Formats**: EAN, UPC, Code128, etc.
- **Error Handling**: Median error checking for accuracy
- **UI**: Overlay drawing for scan feedback

## Development Patterns & Conventions

### State Management
- **React Class Components**: Primary pattern throughout application
- **localStorage**: Primary persistence layer
- **Component State**: Local UI state management
- **Static Properties**: Shared state (e.g., `Look.Current`, collections)

### Storage Architecture
```
localStorage keys:
- `looks`: Array of look IDs
- `${lookId}`: Individual look data
- `${lookId}.${date}`: Look occurrence data  
- `${lookId}.${date}.photos`: Photos for specific occurrence
- `${parentId}.tags`: Tags for any component
- `${className}`: Collection keys for Persisted classes
```

### Error Handling Patterns
- **Crypto Polyfill Issues**: Known issue in Jest environment
- **API Fallbacks**: Graceful degradation when services unavailable
- **Camera Permissions**: Android-specific handling patterns
- **Storage Quotas**: No current handling (future consideration)

### Code Organization
- **Component Co-location**: Components, models, and styles in same directories
- **Service Separation**: External API services isolated in service modules
- **Utility Abstraction**: Common patterns extracted to utility classes

## Development Environment

### Local Development
```bash
# Install dependencies
yarn install

# Start development server
yarn start  # http://localhost:3000

# Start Lambda API (optional, PowerShell required on Windows)
cd server && sam local start-api -p 5000

# Build for production
yarn build

# Deploy to S3
cd build && aws s3 sync . s3://lookbook.wehrly.com
```

### Docker Development
```bash
docker build . -t lookbook
docker run --rm -p 3000:3000 -it -v $(pwd -W):/app lookbook bash
```

## Testing Strategy & Current Issues

### Current State
- **Test Runner**: Jest with React Testing Library
- **Critical Issue**: Crypto polyfill not available in Jest environment
- **Coverage**: Minimal - only default Create React App test
- **CI/CD**: Not currently configured

### Known Issues to Address
1. **Crypto dependency**: `crypto.randomUUID()` usage breaks Jest
2. **External API mocking**: Need mocks for Google Photos API and UPCItemDB
3. **LocalStorage testing**: Requires proper localStorage mocking
4. **Camera permissions**: Testing challenges for barcode scanner

### Testing Priorities (from TEST_IMPLEMENTATION_PLAN.md)
1. Fix crypto polyfill for Jest environment
2. Replace default App.test.tsx with meaningful tests
3. Core Look component CRUD operations
4. localStorage persistence layer validation
5. Google Photos service integration tests
6. Product scanner and barcode lookup tests

## Key Business Logic

### Look Management
- **Creation**: Auto-generates UUID, saves to localStorage
- **Daily Looks**: One primary look per day, identified by date
- **Naming**: Defaults to "Today's Look", user can customize
- **Persistence**: All data stored locally, no backend database

### Photo Integration
- **Source**: Google Photos albums only
- **Selection**: Users pick from their Google Photos albums
- **Storage**: Photo metadata stored locally, actual images remain in Google Photos
- **Organization**: Photos associated with specific look occurrences by date

### Product Tracking
- **Input Method**: Barcode scanning with camera
- **Lookup**: AWS Lambda queries UPCItemDB for product information
- **Categories**: Predefined ProductType enum (Skincare, Makeup, etc.)
- **Association**: Products can be tagged to specific looks

## Performance Considerations

### Current Limitations
- **localStorage Size**: No quota management or cleanup
- **Photo Loading**: Direct Google Photos API calls, no caching
- **Barcode Scanner**: Real-time camera processing, CPU intensive
- **Memory**: No cleanup of large object collections

### Future Optimizations
- Implement localStorage quota monitoring
- Add image caching layer
- Lazy loading for large collections
- Progressive Web App (PWA) capabilities

## Security & Privacy

### Data Storage
- **Local Only**: All user data stored in browser localStorage
- **No Backend Database**: Reduces privacy concerns
- **Google Integration**: Uses OAuth2, requires user consent
- **API Keys**: Exposed in client code (acceptable for public APIs)

### Authentication
- **Google OAuth2**: Read/write access to user's Google Photos
- **Token Management**: Handled by Google Identity Services
- **Session Persistence**: Tokens stored in browser session

## Deployment & Infrastructure

### Production Environment
- **Hosting**: AWS S3 static website
- **CDN**: CloudFront distribution
- **Domain**: lookbook.wehrly.com
- **SSL**: AWS Certificate Manager
- **Infrastructure as Code**: Terraform configurations

### API Services
- **Product Lookup**: AWS Lambda function
- **Google Photos**: Direct client-side API calls
- **CORS**: Configured for cross-origin requests

## Best Practices for AI Assistance

### When Working on This Project:

1. **Understand localStorage Patterns**: This app heavily relies on localStorage for all persistence
2. **Respect React Class Components**: Don't suggest converting to functional components without explicit request
3. **Mind the Crypto Issue**: Be aware of Jest/crypto incompatibility when suggesting tests
4. **Google API Complexity**: Google Photos integration is complex - suggest incremental changes
5. **Mobile Considerations**: Barcode scanning requires mobile camera access
6. **Type Safety**: Maintain TypeScript interfaces, especially for models
7. **Storage Key Patterns**: Follow established localStorage key naming conventions
8. **Component Lifecycle**: Many components have complex initialization due to external APIs

### Preferred Approaches:
- **Small Incremental Changes**: Avoid large refactors
- **Test-First for New Features**: Write tests before implementing
- **Error Handling**: Always consider offline/failure scenarios
- **Performance**: Be mindful of localStorage and memory usage
- **Mobile-First**: Consider mobile UX for camera and touch interactions

### Avoid:
- **Breaking localStorage Schema**: Changes could lose user data
- **Removing Error Handling**: External APIs frequently fail
- **Complex State Management**: Keep React patterns simple
- **Breaking Google Integration**: OAuth flows are fragile

This project represents a personal fashion journaling tool with unique integration challenges around camera access, Google APIs, and local data persistence. Focus on maintaining the existing architecture while incrementally improving functionality and test coverage.
